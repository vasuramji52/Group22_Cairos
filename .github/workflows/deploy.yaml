name: Deploy MERN (main)

on:
  push:
    branches: [main]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend deps
        run: npm ci
        working-directory: backend

      - name: Run backend tests
        run: npm test
        working-directory: backend

  deploy:
    runs-on: ubuntu-latest
    needs: test-backend   # ‚Üê only deploy if tests passed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sshpass (password-based SSH)
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to Droplet
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_KEY: ${{ secrets.SSH_KEY }} # this is your SSH PASSWORD
        run: |
          set -e
          sshpass -p "$SSH_KEY" ssh -o StrictHostKeyChecking=no "$SSH_USERNAME@$SSH_HOST" << 'EOF'
          set -e

          echo "üöÄ Deploying..."

          ############################
          # FRONTEND (Vite React)
          # Repo path on server: /var/cardsServer/api/frontend
          ############################
          cd /var/cardsServer/api/frontend

          echo "üì¶ Sync to latest main"
          git fetch origin
          git reset --hard origin/main

          echo "‚öôÔ∏è Build"
          npm ci
          npm run build

          echo "üß≠ Reload Nginx (root points to dist)"
          sudo nginx -t && sudo systemctl reload nginx

          ############################
          # BACKEND (Node/Express)
          # Repo path on server: /var/cardsServer/api/backend
          ############################
          cd /var/cardsServer/api/backend

          echo "üîÑ Update backend to latest main"
          git fetch origin
          git reset --hard origin/main

          # Install only prod deps on the droplet
          npm ci --omit=dev

          # üëá ensure TZ is set for any fresh pm2 start
          export TZ=America/New_York

          echo "‚ñ∂Ô∏è Restart API"
          pm2 restart express-server || pm2 start server.js --name "express-server"
          pm2 save

          echo "‚úÖ Done."
          EOF